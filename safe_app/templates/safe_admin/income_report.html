{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Income Report - Safe Gym Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #ffffff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 25px 0;
            position: relative;
            border-right: 1px solid #e8ecf0;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
            padding: 0 25px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 25px;
            color: #5a6c7d;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
            font-size: 15px;
            border-radius: 0 25px 25px 0;
            margin-right: 20px;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.1), rgba(46, 204, 113, 0.1));
            color: #2c3e50;
            transform: translateX(5px);
        }

        .nav-link:hover::before {
            transform: scaleY(1);
        }

        .nav-link.active {
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.15), rgba(46, 204, 113, 0.15));
            color: #2c3e50;
            font-weight: 600;
        }

        .nav-link.active::before {
            transform: scaleY(1);
        }

        .nav-icon {
            margin-right: 14px;
            font-size: 20px;
            width: 22px;
            text-align: center;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-toggle {
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            background: #f8f9fa;
            margin-top: 5px;
            border-radius: 0 15px 15px 0;
            overflow: hidden;
            margin-right: 20px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content .nav-link {
            padding: 12px 50px;
            font-size: 14px;
            margin-right: 0;
            border-radius: 0;
        }

        .main-content {
            flex: 1;
            padding: 30px 40px;
            background: #f8f9fa;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
        }

        .header h2 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #5a6c7d;
            border: 2px solid #e8ecf0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #27ae60;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        .filters-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
            margin-bottom: 30px;
        }

        .filters-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .filters-grid {
            display compounding: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-input {
            padding: 12px;
            border: 2px solid #e8ecf0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .report-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .report-header {
            padding: 25px;
            border-bottom: 1px solid #e8ecf0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }

        .report-actions {
            display: flex;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e8ecf0;
            font-size: 14px;
        }

        .report-table td {
            padding: 15px;
            border-bottom: 1px solid #e8ecf0;
            font-size: 14px;
        }

        .report-table tr:hover {
            background: #f8f9fa;
        }

        .amount-cell {
            font-weight: 600;
            color: #27ae60;
        }

        .date-cell {
            color: #7f8c8d;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .pagination {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e8ecf0;
        }

        .pagination-info {
            color: #7f8c8d;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #e8ecf0;
            background: white;
            color: #5a6c7d;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .pagination-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        #incomeChart {
            max-height: 300px;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .profit-loss-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .profit-loss-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .profit-loss-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            text-align: center;
        }

        .summary-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .summary-value.profit {
            color: #27ae60;
        }

        .summary-value.loss {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-actions {
                flex-direction: column;
            }
            
            .report-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .report-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .profit-loss-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="logo">
                <h1>Safe Gym</h1>
                <p>Admin Dashboard</p>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="{% url 'dashboard' %}" class="nav-link {% if request.path == '/dashboard/' %}active{% endif %}">
                            <span class="nav-icon">üìä</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'add_user' %}" class="nav-link {% if request.path == '/add-user/' %}active{% endif %}">
                            <span class="nav-icon">üë§</span>
                            Add User
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'fee_details' %}" class="nav-link {% if request.path == '/fee-details/' %}active{% endif %}">
                            <span class="nav-icon">üí∞</span>
                            Fee Details
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle {% if request.path == '/income-report/' or request.path == '/expense-report/' %}active{% endif %}">
                            <span class="nav-icon">üìã</span>
                            Reports
                        </a>
                        <div class="dropdown-content">
                            <a href="{% url 'income_report' %}" class="nav-link {% if request.path == '/income-report/' %}active{% endif %}">
                                <span class="nav-icon">üìà</span>
                                Income Report
                            </a>
                            <a href="{% url 'expense_report' %}" class="nav-link {% if request.path == '/expense-report/' %}active{% endif %}">
                                <span class="nav-icon">üìâ</span>
                                Expense Report
                            </a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'expenses' %}" class="nav-link {% if request.path == '/expenses/' %}active{% endif %}">
                            <span class="nav-icon">üí∏</span>
                            Expenses
                        </a>
                    </li>
                    {% comment %} <li class="nav-item">
                        <a href="{% url 'fee_adding' %}" class="nav-link {% if request.path == '/fee-adding/' %}active{% endif %}">
                            <span class="nav-icon">‚ûï</span>
                            Fee Adding
                        </a>
                    </li> {% endcomment %}
                    <li class="nav-item">
                        <a href="{% url 'manage_fees' %}" class="nav-link {% if request.path == '/manage-fees/' %}active{% endif %}">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            Manage Fees
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'admin_logout' %}" class="nav-link logout-link {% if request.path == '/logout/' %}active{% endif %}">
                            <span class="nav-icon">üö™</span>
                            Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            {% if messages %}
                {% for message in messages %}
                    <div class="error-message">{{ message }}</div>
                {% endfor %}
            {% endif %}
            <div class="header">
                <h2>Income Report</h2>
                <div class="header-actions">
                    <a href="{% url 'export_income' %}" class="btn btn-secondary">üìä Export PDF</a>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">‚Çπ{{ total_income|floatformat:2 }}</div>
                    <div class="stat-label">Total Income</div>
                    <div class="stat-change {% if income_change < 0 %}negative{% else %}positive{% endif %}">
                        {% if income_change >= 0 %}‚Üó{% else %}‚Üò{% endif %} {{ income_change|floatformat:1 }}% from last month
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value">‚Çπ{{ this_month_income|floatformat:2 }}</div>
                    <div class="stat-label">This Month</div>
                    <div class="stat-change {% if this_month_change < 0 %}negative{% else %}positive{% endif %}">
                        {% if this_month_change >= 0 %}‚Üó{% else %}‚Üò{% endif %} {{ this_month_change|floatformat:1 }}% from last month
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value">‚Çπ{{ avg_monthly_income|floatformat:2 }}</div>
                    <div class="stat-label">Average Monthly</div>
                    <div class="stat-change {% if avg_monthly_change < 0 %}negative{% else %}positive{% endif %}">
                        {% if avg_monthly_change >= 0 %}‚Üó{% else %}‚Üò{% endif %} {{ avg_monthly_change|floatformat:1 }}% from last year
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value">{{ active_members }}</div>
                    <div class="stat-label">Active Members</div>
                    <div class="stat-change positive">‚Üó +{{ new_members }} new members</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-container">
                <h3 class="filters-title">Filter Income Records</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Select Month</label>
                        <select class="filter-input" id="monthSelect">
                            {% for year, months in available_months %}
                                {% for month in months %}
                                    <option value="{{ year }}-{{ month.num }}" {% if year == current_year and month.num == current_month %}selected{% endif %}>
                                        {{ month.name }} {{ year }}
                                    </option>
                                {% endfor %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-secondary" id="clearFilters">Clear Filters</button>
                    <button class="btn btn-primary" id="generateReport">üìà Generate Profit/Loss Report</button>
                </div>
            </div>

            <!-- Profit/Loss Report -->
            <div class="profit-loss-container" id="profitLossReport">
                <h3 class="profit-loss-title">Profit/Loss Report</h3>
                <div class="profit-loss-summary">
                    <div class="summary-item">
                        <div class="summary-label">Period</div>
                        <div class="summary-value" id="reportPeriod"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Income</div>
                        <div class="summary-value" id="totalIncome"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Expenses</div>
                        <div class="summary-value" id="totalExpenses"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label" id="profitLossLabel"></div>
                        <div class="summary-value" id="profitLossAmount"></div>
                    </div>
                </div>
                <h4>Income Details</h4>
                <div class="table-container">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer ID</th>
                                <th>Package</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="incomeDetailsBody"></tbody>
                    </table>
                </div>
                <h4>Expense Details</h4>
                <div class="table-container">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Purchase Item</th>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="expenseDetailsBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentPage = 1;
        const itemsPerPage = 10;
        let incomeData = [];
        let filteredData = [];

        async function fetchIncomeData(filters = {}) {
            try {
                let url = '/get-income-data/';
                
                if (filters.month) {
                    url += `?month=${encodeURIComponent(filters.month)}`;
                }
                
                console.log('Fetching from URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                
                if (result.success) {
                    incomeData = result.data || [];
                    filteredData = [...incomeData];
                    currentPage = 1;
                    
                    renderIncomeTable();
                    
                    if (result.chart_data && result.chart_data.labels.length > 0) {
                        initializeChart(result.chart_data);
                    } else {
                        console.warn('No chart data available');
                        initializeChart({labels: [], values: []});
                    }
                    
                    console.log('Data loaded successfully:', incomeData.length, 'records');
                } else {
                    throw new Error(result.message || 'Server returned error');
                }
                
            } catch (error) {
                console.error('Fetch error:', error);
                showErrorMessage(`Failed to load data: ${error.message}`);
                
                const tableBody = document.getElementById('incomeTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px; color: #e74c3c;">
                                <h3>Error Loading Data</h3>
                                <p style="margin-top: 10px;">${error.message}</p>
                                <button class="btn btn-primary" onclick="fetchIncomeData()" style="margin-top: 10px;">
                                    Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.classList.contains('dropdown-toggle')) {
                    e.preventDefault();
                    const dropdownContent = this.nextElementSibling;
                    dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
                } else if (!this.classList.contains('logout-link')) {
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    if (!this.parentElement.parentElement.classList.contains('dropdown-content')) {
                        this.classList.add('active');
                    }
                    window.location.href = this.href;
                }
            });
        });

        function formatDate(dateInput) {
            if (!dateInput) return '-';
            try {
                if (typeof dateInput === 'string') {
                    const date = new Date(dateInput);
                    return date.toLocaleDateString('en-GB');
                } else if (typeof dateInput === 'number') {
                    const date = new Date(dateInput * 1000);
                    return date.toLocaleDateString('en-GB');
                } else if (dateInput instanceof Date) {
                    return dateInput.toLocaleDateString('en-GB');
                }
                return '-';
            } catch (e) {
                console.error('Error formatting date:', e, dateInput);
                return '-';
            }
        }

        function formatCurrency(amount) {
            if (isNaN(amount)) {
                console.error('Invalid amount:', amount);
                return '‚Çπ0.00';
            }
            return '‚Çπ' + parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function getStatusBadge(status) {
            const statusStr = String(status).toLowerCase();
            if (statusStr === 'paid' || statusStr === '1') {
                return '<span class="status-badge status-active">Paid</span>';
            } else if (statusStr === 'pending' || statusStr === '0') {
                return '<span class="status-badge status-pending">Pending</span>';
            } else if (statusStr === 'overdue' || statusStr === '2') {
                return '<span class="status-badge status-overdue">Overdue</span>';
            }
            return '<span class="status-badge">Unknown</span>';
        }

        async function generateProfitLossReport() {
            const month = document.getElementById('monthSelect').value;
            const params = new URLSearchParams({ month });

            try {
                const generateBtn = document.getElementById('generateReport');
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';

                const response = await fetch(`{% url 'profit_loss_report' %}?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.success) {
                    const reportContainer = document.getElementById('profitLossReport');
                    reportContainer.style.display = 'block';
                    window.scrollTo({
                        top: reportContainer.offsetTop,
                        behavior: 'smooth'
                    });

                    const [year, monthNum] = result.month.split('-');
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                      'July', 'August', 'September', 'October', 'November', 'December'];
                    document.getElementById('reportPeriod').textContent = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                    
                    document.getElementById('totalIncome').textContent = formatCurrency(result.total_income);
                    document.getElementById('totalExpenses').textContent = formatCurrency(result.total_expenses);
                    document.getElementById('profitLossAmount').textContent = formatCurrency(Math.abs(result.profit_loss));
                    document.getElementById('profitLossLabel').textContent = result.profit_loss >= 0 ? 'Profit' : 'Loss';
                    document.getElementById('profitLossAmount').className = `summary-value ${result.profit_loss >= 0 ? 'positive' : 'negative'}`;

                    const incomeDetailsBody = document.getElementById('incomeDetailsBody');
                    incomeDetailsBody.innerHTML = result.income_details.length ? result.income_details.map(item => `
                        <tr>
                            <td>${formatDate(item.date)}</td>
                            <td>${item.customer_id || 'N/A'}</td>
                            <td>${item.package || 'N/A'}</td>
                            <td>${formatCurrency(item.amount)}</td>
                            <td>${getStatusBadge(item.status)}</td>
                        </tr>
                    `).join('') : `
                        <tr>
                            <td colspan="5" class="text-center">No income records found</td>
                        </tr>
                    `;

                    const expenseDetailsBody = document.getElementById('expenseDetailsBody');
                    expenseDetailsBody.innerHTML = result.expense_details.length ? result.expense_details.map(item => `
                        <tr>
                            <td>${formatDate(item.date)}</td>
                            <td>${item.purchase || 'N/A'}</td>
                            <td>${item.description || 'N/A'}</td>
                            <td>${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('') : `
                        <tr>
                            <td colspan="4" class="text-center">No expense records found</td>
                        </tr>
                    `;
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate report: ' + error.message);
            } finally {
                const generateBtn = document.getElementById('generateReport');
                generateBtn.disabled = false;
                generateBtn.textContent = 'üìà Generate Profit/Loss Report';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('generateReport').addEventListener('click', generateProfitLossReport);
        });

        function renderTable(elementId, data, columns) {
            const tableBody = document.getElementById(elementId);
            if (!data.length) {
                tableBody.innerHTML = `<tr><td colspan="${columns.length}" class="text-center">No data found</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(item => `
                <tr>
                    ${columns.map(col => `<td>${item[col] || '-'}</td>`).join('')}
                </tr>
            `).join('');
        }

        function formatCurrency(amount) {
            if (isNaN(amount)) {
                console.error('Invalid amount:', amount);
                return '‚Çπ0.00';
            }
            return '‚Çπ' + parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationControls = document.getElementById('paginationControls');
            
            paginationInfo.textContent = `Showing ${(currentPage - 1) * itemsPerPage + 1} to ${Math.min(currentPage * itemsPerPage, filteredData.length)} of ${filteredData.length} records`;
            
            paginationControls.innerHTML = `
                <button class="pagination-btn" id="prevBtn" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                ${Array.from({length: totalPages}, (_, i) => 
                    `<button class="pagination-btn ${currentPage === i + 1 ? 'active' : ''}" onclick="changePage(${i + 1})">${i + 1}</button>`
                ).join('')}
                <button class="pagination-btn" id="nextBtn" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
            `;

            document.getElementById('prevBtn').onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    updatePagination();
                }
            };

            document.getElementById('nextBtn').onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    updatePagination();
                }
            };
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
            updatePagination();
        }

        async function viewRecord(id) {
            try {
                const response = await fetch(`{% url 'edit_fee' 0 %}`.replace('0', id));
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    const item = result.data;
                    alert(`Viewing income details for: ${item.name}
Member ID: ${item.customer_id}
Amount: ${formatCurrency(item.total_amount)}
Package: ${item.package}
Date: ${formatDate(item.date)}
Status: ${item.status === '1' ? 'Paid' : item.status === '0' ? 'Pending' : 'Overdue'}`);
                } else {
                    alert('Error fetching record details: ' + result.message);
                }
            } catch (error) {
                alert('Error fetching record details: ' + error.message);
            }
        }

        async function generateProfitLossReport() {
            const month = document.getElementById('monthSelect').value;
            console.log('Generating profit/loss report for month:', month);
            const params = new URLSearchParams({ month });

            try {
                const response = await fetch(`{% url 'profit_loss_report' %}?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                console.log('Profit/loss report response:', result);

                if (result.success) {
                    const reportContainer = document.getElementById('profitLossReport');
                    reportContainer.style.display = 'block';
                    window.scrollTo({
                        top: reportContainer.offsetTop,
                        behavior: 'smooth'
                    });

                    const monthNames = [
                        'January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'
                    ];
                    const [year, monthNum] = result.month.split('-');
                    document.getElementById('reportPeriod').textContent = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                    document.getElementById('totalIncome').textContent = formatCurrency(result.total_income);
                    document.getElementById('totalExpenses').textContent = formatCurrency(result.total_expenses);
                    document.getElementById('profitLossLabel').textContent = result.status;
                    document.getElementById('profitLossAmount').textContent = formatCurrency(Math.abs(result.profit_loss));
                    document.getElementById('profitLossAmount').className = `summary-value ${result.status.toLowerCase()}`;

                    const incomeDetailsBody = document.getElementById('incomeDetailsBody');
                    incomeDetailsBody.innerHTML = result.income_details.length ? result.income_details.map(item => {
                        let dateDisplay;
                        try {
                            dateDisplay = item.date ? formatDate(item.date) : '-';
                        } catch (e) {
                            console.error('Error formatting income date:', e);
                            dateDisplay = '-';
                        }

                        return `
                            <tr>
                                <td class="date-cell">${dateDisplay}</td>
                                <td>${item.customer_id || 'N/A'}</td>
                                <td>${item.package || 'N/A'}</td>
                                <td class="amount-cell">${formatCurrency(item.amount)}</td>
                                <td>${getStatusBadge(item.status)}</td>
                            </tr>
                        `;
                    }).join('') : `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px;">
                                <h3>No Income Records Found</h3>
                            </td>
                        </tr>
                    `;

                    const expenseDetailsBody = document.getElementById('expenseDetailsBody');
                    expenseDetailsBody.innerHTML = result.expense_details.length ? result.expense_details.map(item => {
                        let dateDisplay;
                        try {
                            dateDisplay = item.date ? formatDate(item.date) : '-';
                        } catch (e) {
                            console.error('Error formatting expense date:', e);
                            dateDisplay = '-';
                        }

                        return `
                            <tr>
                                <td class="date-cell">${dateDisplay}</td>
                                <td>${item.purchase || 'N/A'}</td>
                                <td>${item.description || 'N/A'}</td>
                                <td class="amount-cell">${formatCurrency(item.amount)}</td>
                            </tr>
                        `;
                    }).join('') : `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                <h3>No Expense Records Found</h3>
                            </td>
                        </tr>
                    `;
                } else {
                    console.error('Error generating report:', result.message);
                    alert('Error generating report: ' + result.message);
                }
            } catch (error) {
                console.error('Error generating profit/loss report:', error);
                alert('Failed to generate profit/loss report: ' + error.message);
            }
        }

        async function fetchIncomeData(month) {
            try {
                const response = await fetch(`/get-income-data/?month=${month}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const result = await response.json();
                if (result.success) {
                    console.log('Fetched income data:', result.data);
                    console.log('Chart data:', result.chart_data);
                } else {
                    console.error('Server error:', result.message);
                }
            } catch (error) {
                console.error('Error fetching income data:', error);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.getElementById('clearFilters').addEventListener('click', function() {
            const monthSelect = document.getElementById('monthSelect');
            const today = new Date();
            monthSelect.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('profitLossReport').style.display = 'none';
            fetchIncomeData({ month: monthSelect.value });
        });

        document.getElementById('copyTable').addEventListener('click', function() {
            const table = document.querySelector('.report-table');
            const range = document.createRange();
            range.selectNodeContents(table);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
            alert('Table copied to clipboard!');
        });

        document.getElementById('generateReport').addEventListener('click', generateProfitLossReport);

        const monthSelect = document.getElementById('monthSelect');
        fetchIncomeData({ month: monthSelect.value });
    </script>
</body>
</html>