{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Fee Details - Safe Gym Admin</title>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/responsive.dataTables.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #ffffff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 25px 0;
            position: relative;
            border-right: 1px solid #e8ecf0;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
            padding: 0 25px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

            .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 999;
        padding-top: 60px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    .modal-content {
        background-color: #fff;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
    }

    .modal-header, .modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .close {
        font-size: 28px;
        cursor: pointer;
    }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 25px;
            color: #5a6c7d;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
            font-size: 15px;
            border-radius: 0 25px 25px 0;
            margin-right: 20px;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.1), rgba(46, 204, 113, 0.1));
            color: #2c3e50;
            transform: translateX(5px);
        }

        .nav-link:hover::before {
            transform: scaleY(1);
        }

        .nav-link.active {
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.15), rgba(46, 204, 113, 0.15));
            color: #2c3e50;
            font-weight: 600;
        }

        .nav-link.active::before {
            transform: scaleY(1);
        }

        .nav-icon {
            margin-right: 14px;
            font-size: 20px;
            width: 22px;
            text-align: center;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-toggle {
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            background: #f8f9fa;
            margin-top: 5px;
            border-radius: 0 15px 15px 0;
            overflow: hidden;
            margin-right: 20px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content .nav-link {
            padding: 12px 50px;
            font-size: 14px;
            margin-right: 0;
            border-radius: 0;
        }

        .main-content {
            flex: 1;
            padding: 30px 40px;
            background: #f8f9fa;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
        }

        .header h2 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #5a6c7d;
            border: 2px solid #e8ecf0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .content-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-break {
            background: #ffd1dc;
            color: #8b4513;
        }

        .status-overdue {
            background: #e74c3c;
            color: white;
        }

        .due-soon {
            color: #f1c40f;
            font-weight: 600;
            display: block;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 10px;
            border-radius: 6px;
            min-width: 60px;
            text-align: center;
            white-space: nowrap;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-edit:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-break {
            background: #ff6b6b;
            color: white;
        }

        .btn-break:hover {
            background: #e55555;
            transform: translateY(-1px);
        }

        .btn-unbreak {
            background: #2ecc71;
            color: white;
        }

        .btn-unbreak:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #20b855;
            transform: translateY(-1px);
        }

        .btn-overdue {
            background: #e74c3c;
            color: white;
        }

        .btn-overdue:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .btn-receipt {
            background: #9b59b6;
            color: white;
        }

        .btn-receipt:hover {
            background: #8e44ad;
            transform: translateY(-1px);
        }

        .btn-history {
            background: #f39c12;
            color: white;
        }

        .btn-history:hover {
            background: #d68910;
            transform: translateY(-1px);
        }

        /* DataTable Customization */
        .dataTables_wrapper {
            margin-top: 20px;
        }

        .dataTables_filter {
            margin-bottom: 20px;
        }

        .dataTables_filter input {
            padding: 8px 12px;
            border: 2px solid #e8ecf0;
            border-radius: 8px;
            font-family: inherit;
            margin-left: 10px;
        }

        .dataTables_filter input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .dataTables_length select {
            padding: 8px 12px;
            border: 2px solid #e8ecf0;
            border-radius: 8px;
            font-family: inherit;
            margin: 0 10px;
        }

        .dataTables_info {
            color: #7f8c8d;
            font-weight: 500;
        }

        .dataTables_paginate .paginate_button {
            padding: 8px 12px;
            margin: 0 2px;
            border: 2px solid #e8ecf0;
            background: white;
            color: #5a6c7d;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dataTables_paginate .paginate_button:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .dataTables_paginate .paginate_button.current {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        table.dataTable {
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table.dataTable thead th {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            padding: 18px 15px;
            font-weight: 600;
            text-align: left;
            font-size: 14px;
            border-bottom: 2px solid #e8ecf0;
        }

        table.dataTable tbody td {
            padding: 15px;
            border-bottom: 1px solid #e8ecf0;
            color: #2c3e50;
            font-size: 14px;
        }

        table.dataTable tbody tr:hover {
            background: #f8f9fa;
        }

        table.dataTable tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        /* Filter Section */
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e8ecf0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-input {
            padding: 12px;
            border: 2px solid #e8ecf0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #ffffff;
            color: #2c3e50;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8ecf0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .modal-body {
            margin-bottom: 25px;
            max-height: 400px; /* Adjust height as needed */
            overflow-y: auto; /* Enable vertical scrolling */
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8ecf0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        /* Enhanced Pagination Styles */
.dataTables_paginate {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
}

.status-badge.status-overdue {
    background-color: #ff0000;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
}
.status-badge.status-active {
    background-color: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
}
.status-badge.status-active[style*="ffeb3b"] {
    background-color: #ffeb3b;
    color: black;
}
.status-badge.status-pending {
    background-color: #ffc107;
    color: black;
    padding: 4px 8px;
    border-radius: 4px;
}
.status-badge.status-break {
    background-color: #6c757d;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
}
.dataTables_paginate .paginate_button {
    padding: 8px 16px;
    margin: 0 4px;
    border: 2px solid #e8ecf0;
    background: #ffffff;
    color: #2c3e50;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
}

.dataTables_paginate .paginate_button:hover {
    background: linear-gradient(45deg, #3498db, #2ecc71);
    color: #ffffff;
    border-color: transparent;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
}

.dataTables_paginate .paginate_button.current {
    background: linear-gradient(45deg, #3498db, #2ecc71);
    color: #ffffff;
    border-color: transparent;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
}

.dataTables_paginate .paginate_button.disabled {
    background: #f8f9fa;
    color: #7f8c8d;
    border-color: #e8ecf0;
    cursor: not-allowed;
    opacity: 0.6;
}

.dataTables_paginate .paginate_button.previous,
.dataTables_paginate .paginate_button.next {
    font-weight: 600;
    padding: 8px 20px;
}

.dataTables_paginate .paginate_button.previous::before,
.dataTables_paginate .paginate_button.next::after {
    font-family: 'Inter', sans-serif;
    font-weight: 700;
}

.dataTables_paginate .paginate_button.previous::before {
    content: '‚Üê';
    margin-right: 8px;
}

.dataTables_paginate .paginate_button.next::after {
    content: '‚Üí';
    margin-left: 8px;
}

.dataTables_paginate .ellipsis {
    padding: 8px 12px;
    color: #7f8c8d;
    font-size: 14px;
    background: transparent;
    border: none;
    cursor: default;
}

/* Responsive Pagination */
@media (max-width: 768px) {
    .dataTables_paginate {
        justify-content: center;
        flex-wrap: wrap;
    }

    .dataTables_paginate .paginate_button {
        padding: 6px 12px;
        min-width: 36px;
        height: 36px;
        font-size: 12px;
    }

    .dataTables_paginate .paginate_button.previous,
    .dataTables_paginate .paginate_button.next {
        padding: 6px 16px;
    }
}
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                justify-content: center;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
                max-height: 85vh;
            }

            .action-buttons {
                flex-direction: column;
                gap: 2px;
            }

            .btn-sm {
                font-size: 9px;
                padding: 4px 6px;
                min-width: 50px;
            }
        }
        /* Darken the backdrop */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.4) !important;
}

/* Make modal content scrollable if it's too large */
.modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

/* Ensure modal body doesn't overflow the screen */
.modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

/* Ensure modal doesn't exceed screen width */
.modal-dialog {
    max-width: 90%; /* Adjust based on your preference */
}

    </style>
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="logo">
                <h1>Safe Gym</h1>
                <p>Admin Dashboard</p>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="{% url 'dashboard' %}" class="nav-link {% if request.path == '/dashboard/' %}active{% endif %}">
                            <span class="nav-icon">üìä</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'add_user' %}" class="nav-link {% if request.path == '/add-user/' %}active{% endif %}">
                            <span class="nav-icon">üë§</span>
                            Add User
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'fee_details' %}" class="nav-link {% if request.path == '/fee-details/' %}active{% endif %}">
                            <span class="nav-icon">üí∞</span>
                            Fee Details
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle {% if request.path == '/income-report/' or request.path == '/expense-report/' %}active{% endif %}">
                            <span class="nav-icon">üìã</span>
                            Reports
                        </a>
                        <div class="dropdown-content">
                            <a href="{% url 'income_report' %}" class="nav-link {% if request.path == '/income-report/' %}active{% endif %}">
                                <span class="nav-icon">üìà</span>
                                Income Report
                            </a>
                            <a href="{% url 'expense_report' %}" class="nav-link {% if request.path == '/expense-report/' %}active{% endif %}">
                                <span class="nav-icon">üìâ</span>
                                Expense Report
                            </a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'expenses' %}" class="nav-link {% if request.path == '/expenses/' %}active{% endif %}">
                            <span class="nav-icon">üí∏</span>
                            Expenses
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'manage_fees' %}" class="nav-link {% if request.path == '/manage-fees/' %}active{% endif %}">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            Manage Fees
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'admin_logout' %}" class="nav-link logout-link {% if request.path == '/logout/' %}active{% endif %}">
                            <span class="nav-icon">üö™</span>
                            Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

<main class="main-content">
    {% if messages %}
        {% for message in messages %}
            <div class="error-message">{{ message }}</div>
        {% endfor %}
    {% endif %}
    <div class="header">
        <h2>Fee Details</h2>
    </div>

    <div class="content-container">
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Month</label>
                <select class="filter-input" id="monthFilter">
                    <option value="">All Months</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="filter-input" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Pending">Pending</option>
                    <option value="On Break">On Break</option>
                    <option value="Overdue">Overdue</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Package</label>
                <select class="filter-input" id="packageFilter">
                    <option value="">All Packages</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-secondary" onclick="resetFilters()">üîÑ Reset Filters</button>
            </div>
        </div>

        <!-- Fee Details DataTable -->
        <table class="display responsive nowrap" id="feeTable" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Customer ID</th>
                    <th>Package</th>
                    <th>Amount (‚Çπ)</th>
                    <th>Month</th>
                    <th>Join Date</th>
                    <th>Payment Date</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table data will be populated by DataTable -->
            </tbody>
        </table>
    </div>
 </main>
</div>

<!-- Edit Fee Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Fee</h3>
                <span class="close" onclick="closeModal('editModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <input type="hidden" id="editFeeId">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer ID</label>
                        <input type="text" class="form-input" id="editCustomerId" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Package</label>
                        <select class="form-input" id="editPackage" required>
                            <option value="">Select Package</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" id="editAmount" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Advance</label>
                        <input type="number" class="form-input" id="editAdvance" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Amount</label>
                        <input type="number" class="form-input" id="editTotalAmount" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Join Date</label>
                        <input type="date" class="form-input" id="editDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Paid</label>
                        <input type="date" class="form-input" id="editLastPaid" onchange="updateDueDate()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" id="editDueDate" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Month</label>
                        <input type="text" class="form-input" id="editMonth">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editStatus">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transaction Type</label>
                        <select class="form-input" id="editTransactionType">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveCustomer()">Update Fee</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsappModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Send WhatsApp Message</h3>
                <span class="close" onclick="closeModal('whatsappModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Customer Name:</label>
                    <input type="text" class="form-input" id="whatsappCustomerName" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number:</label>
                    <input type="text" class="form-input" id="whatsappPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Message:</label>
                    <textarea class="form-input form-textarea" id="whatsappMessage" placeholder="Enter your message here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('whatsappModal')">Cancel</button>
                <button class="btn btn-primary" onclick="sendWhatsAppMessage()">Send Message</button>
            </div>
        </div>
    </div>

<!-- Payment History Modal -->
<div id="historyModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyModalLabel">Payment History</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="paymentHistoryContent">
            <table id="paymentHistoryTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


    <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- DataTables JS and its extensions -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.responsive.min.js"></script>


<!-- Required libraries for exporting (JSZip, PDFMake) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

    

<script>
// Existing variables
let feeData = [];
let feeDataTable;
const PACKAGE_DURATIONS = { 'Monthly': 1, 'Quarterly': 3, 'Yearly': 12 };
let dynamicPackageDurations = {};
let packageConfig = {};

// Helper Function to Get CSRF Token from Cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Get CSRF Token
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content ||
           document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
           getCookie('csrftoken') || '';
}

// Format Date
function formatDate(dateString) {
    return dateString ? new Date(dateString).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
}

// Format Currency
function formatCurrency(amount) {
    return amount ? '‚Çπ' + Number(amount).toFixed(2) : '‚Çπ0.00';
}

// Get Status Badge
function getStatusBadge(fee) {
    const today = new Date();
    const dueDate = fee.due_date ? new Date(fee.due_date) : null;
    const daysUntilDue = dueDate ? Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)) : null;

    if (fee.status === 3) return '<span class="status-badge status-break">On Break</span>';
    if (fee.is_overdue || (dueDate && dueDate < today)) return '<span class="status-badge status-overdue" style="background-color: #ff0000; color: white;">Overdue</span>';
    if (daysUntilDue <= 4 && daysUntilDue >= 0) return `<span class="status-badge status-active" style="background-color: #ffeb3b; color: black;">Active (Expiring in ${daysUntilDue} days!)</span>`;
    return {
        1: '<span class="status-badge status-active" style="background-color: #28a745; color: white;">Active</span>',
        0: '<span class="status-badge status-inactive" style="background-color: #dc3545; color: white;">Inactive</span>',
        2: '<span class="status-badge status-pending" style="background-color: #ffc107; color: black;">Pending</span>'
    }[fee.status] || '<span class="status-badge">Unknown</span>';
}

// Helper Function for Status Text
function getStatusText(status) {
    switch (Number(status)) {
        case 1: return '<span class="status-badge status-active">Active</span>';
        case 0: return '<span class="status-badge status-inactive">Inactive</span>';
        case 2: return '<span class="status-badge status-pending">Pending</span>';
        case 3: return '<span class="status-badge status-break">On Break</span>';
        default: return '<span class="status-badge">Unknown</span>';
    }
}

// Get Status for Filtering
function getStatusForFilter(fee) {
    if (fee.is_overdue && fee.status !== 3) return 'Overdue';
    switch (Number(fee.status)) {
        case 1: return 'Active';
        case 0: return 'Inactive';
        case 2: return 'Pending';
        case 3: return 'On Break';
        default: return 'Unknown';
    }
}

// Populate Filters
function populateFilters() {
    const monthSelect = document.getElementById('monthFilter');
    const uniqueMonths = [...new Set(feeData.map(f => f.month).filter(m => m))];
    monthSelect.innerHTML = '<option value="">All Months</option>' + uniqueMonths.map(m => `<option value="${m}">${m}</option>`).join('');

    const packageSelect = document.getElementById('packageFilter');
    const uniquePackages = [...new Set(feeData.map(f => f.package).filter(p => p))];
    packageSelect.innerHTML = '<option value="">All Packages</option>' + uniquePackages.map(p => `<option value="${p}">${p}</option>`).join('');
}

// Fetch Packages from Backend
async function fetchPackages() {
    try {
        const response = await fetch('{% url "get_packages" %}', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        console.log('Fetched Packages Response:', result);
        if (result.success && result.packages) {
            packageConfig = result.package_config || {};
            dynamicPackageDurations = result.packages.reduce((acc, pkg) => ({ ...acc, [pkg.package]: pkg.duration || 1 }), {});
            packageConfig = result.packages.reduce((acc, pkg) => ({ ...acc, [pkg.package]: { amount: pkg.amount, duration: pkg.duration } }), {});
            const editPackageSelect = document.getElementById('editPackage');
            editPackageSelect.innerHTML = '<option value="">Select Package</option>';
            result.packages.forEach(pkg => {
                const optionText = `${pkg.package} (‚Çπ${pkg.amount.toFixed(2)}, ${pkg.duration} months)`;
                editPackageSelect.innerHTML += `<option value="${pkg.package}" data-duration="${pkg.duration}" data-amount="${pkg.amount}">${optionText}</option>`;
            });
        } else {
            console.warn('Failed to load packages:', result.message || 'No packages available');
            alert('Failed to load packages: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error loading packages:', error);
        alert('Error loading packages: ' + error.message);
    }
}

// Update Due Date
function updateDueDate() {
    const lastPaidDate = new Date($('#editLastPaid').val() || new Date());
    const packageName = $('#editPackage').val();
    const duration = dynamicPackageDurations[packageName] || PACKAGE_DURATIONS[packageName] || 1;

    if (!isNaN(lastPaidDate.getTime()) && packageName) {
        const dueDate = new Date(lastPaidDate);
        dueDate.setMonth(dueDate.getMonth() + duration);
        if (dueDate.getDate() < lastPaidDate.getDate()) dueDate.setDate(0);
        $('#editDueDate').val(dueDate.toISOString().split('T')[0]);
        $('#editMonth').val(['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][dueDate.getMonth()]);
    } else {
        $('#editDueDate').val('');
        $('#editMonth').val('');
    }
}

// Update Total Amount
function updateTotalAmount() {
    const amount = parseFloat(document.getElementById('editAmount').value) || 0;
    const advance = parseFloat(document.getElementById('editAdvance').value) || 0;
    document.getElementById('editTotalAmount').value = (amount - advance).toFixed(2);
}

// Update Amount Based on Package Selection
function updateAmountBasedOnPackage() {
    const packageName = $('#editPackage').val();
    if (packageName && packageConfig[packageName]) {
        const amount = packageConfig[packageName].amount || 0;
        $('#editAmount').val(amount.toFixed(2));
        $('#editAdvance').val((amount * 0.5).toFixed(2)); // Optional: Set advance to 50% of amount
        updateTotalAmount();
    } else {
        $('#editAmount').val('');
        $('#editAdvance').val('');
        $('#editTotalAmount').val('');
    }
}

// Fetch Fee Data from Backend
async function fetchFeeData() {
    try {
        const response = await fetch('{% url "get_customers_data" %}?t=' + new Date().getTime(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            cache: 'no-store'
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        console.log('Fetched Fee Data Response:', result);
        if (result.success) {
            const today = new Date();
            feeData = result.data.map((fee, index) => {
                const dueDate = fee.due_date ? new Date(fee.due_date) : null;
                const isOverdue = dueDate && dueDate < today && fee.status !== 3;
                const daysUntilDue = dueDate ? Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)) : null;
                const isDueSoon = dueDate && !isOverdue && daysUntilDue <= 4 && daysUntilDue >= 0;
                let status = fee.status !== undefined ? fee.status : 2;
                if (isOverdue) status = 0;
                else if (isDueSoon && fee.status !== 3) status = 1;
                else if (fee.status === 3) status = 3;
                return {
                    id: fee.id || index + 1,
                    name: fee.name || 'Unknown',
                    customer_id: fee.customer_id || '-',
                    package: fee.package || '-',
                    total_amount: fee.total_amount || fee.amount || 0,
                    month: fee.month || '-',
                    date: fee.date || null,
                    last_paid: fee.last_paid || null,
                    due_date: fee.due_date || null,
                    status: status,
                    phone: fee.phone || '',
                    email: fee.email || '',
                    break_status: fee.status === 3,
                    is_overdue: isOverdue,
                    is_due_soon: isDueSoon,
                    advance: fee.advance || 0,
                    transaction_type: fee.transaction_type || 'Cash'
                };
            });
            console.log('Processed Fee Data:', feeData);
            populateFilters();
            initializeDataTable();
        } else {
            console.error('Error fetching data:', result.message);
            alert('Error loading fee data: ' + result.message);
        }
    } catch (error) {
        console.error('Error fetching data:', error);
        alert('Error loading fee data. Please try again later.');
    }
}

// Initialize DataTable
function initializeDataTable() {
    if (feeDataTable) feeDataTable.destroy();

    feeDataTable = $('#feeTable').DataTable({
        data: feeData,
        responsive: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        order: [[0, 'desc']],
        dom: 'Bfrtip',
        buttons: [
            { extend: 'excel', text: 'üìä Export Excel', className: 'btn btn-primary btn-sm', exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] } },
            { extend: 'pdf', text: 'üìÑ Export PDF', className: 'btn btn-primary btn-sm', exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] } },
            { extend: 'print', text: 'üñ®Ô∏è Print', className: 'btn btn-primary btn-sm', exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] } }
        ],
        columns: [
            { data: 'id', title: 'ID', width: '5%' },
            { data: 'name', title: 'Name', render: function(data) { return `<strong>${data || 'Unknown'}</strong>`; } },
            { data: 'customer_id', title: 'Customer ID' },
            { data: 'package', title: 'Package' },
            { data: 'total_amount', title: 'Amount', render: function(data) { return `<strong>${formatCurrency(data)}</strong>`; } },
            { data: 'month', title: 'Month', render: function(data) { return `<strong>${data || '-'}</strong>`; } },
            { data: 'date', title: 'Join Date', render: function(data) { return formatDate(data); } },
            { data: 'last_paid', title: 'Payment Date', render: function(data) { return `<strong>${formatDate(data)}</strong>`; } },
            { data: 'due_date', title: 'Due Date', render: function(data) { return `<strong>${formatDate(data)}</strong>`; } },
            { data: null, title: 'Status', render: function(data, type, row) { return getStatusBadge(row); } },
            {
                data: null,
                title: 'Actions',
                orderable: false,
                searchable: false,
                render: function(data, type, row) {
                    const isOnBreak = row.status === 3;
                    const isOverdue = row.is_overdue || (row.due_date && new Date(row.due_date) < new Date());
                    return `
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-edit" onclick="editFee(${row.id})" title="Edit Fee">‚úèÔ∏è</button>
                            ${isOnBreak ?
                                `<button class="btn btn-sm btn-unbreak" onclick="unbreakMember(${row.id})" title="Unbreak Member">‚ñ∂Ô∏è</button>` :
                                `<button class="btn btn-sm btn-break" onclick="breakMember(${row.id})" title="Break Member">‚è∏Ô∏è</button>`
                            }
                            <button class="btn btn-sm btn-whatsapp" onclick="openWhatsAppModal(${row.id})" title="Send WhatsApp">üì±</button>
                            ${isOverdue ?
                                `<button class="btn btn-sm btn-overdue" onclick="sendOverdueNotice(${row.id})" title="Send Overdue Notice">‚ö†Ô∏è</button>` : ''
                            }
                            <button class="btn btn-sm btn-receipt" onclick="printReceipt(${row.id})" title="Print Receipt">üßæ</button>
                            <button class="btn btn-sm btn-history" onclick="showPaymentHistory(${row.id}, '${row.name}')" title="Payment History">üìä</button>
                        </div>
                    `;
                }
            }
        ],
        language: {
            search: "Search records:",
            lengthMenu: "Show _MENU_ records per page",
            info: "Showing _START_ to _END_ of _TOTAL_ records",
            infoEmpty: "Showing 0 to 0 of 0 records",
            infoFiltered: "(filtered from _MAX_ total records)",
            zeroRecords: "No matching records found",
            emptyTable: "No fee records available"
        }
    });

    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        if (settings.nTable.id !== 'feeTable') return true;
        const monthFilter = $('#monthFilter').val();
        const statusFilter = $('#statusFilter').val();
        const packageFilter = $('#packageFilter').val();
        const rowData = feeDataTable.row(dataIndex).data();
        if (monthFilter && rowData.month !== monthFilter) return false;
        if (statusFilter && getStatusForFilter(rowData) !== statusFilter) return false;
        if (packageFilter && rowData.package !== packageFilter) return false;
        return true;
    });
}

// Apply Custom Filters
function applyFilters() {
    if (feeDataTable) feeDataTable.draw();
}

// Reset Filters
function resetFilters() {
    document.getElementById('monthFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('packageFilter').value = '';
    if (feeDataTable) feeDataTable.search('').draw();
}

function fetchAndFillFee(customerId) {
    $.get(`api/fees/update/${customerId}/`, function(response) {
        if (response.success) {
            const fee = response.data;
            $('#editFeeId').val(fee.id);
            $('#editCustomerId').val(fee.customer_id);
            $('#editName').val(fee.name);
            $('#editPackage').val(fee.package);
            $('#editMonth').val(fee.month);
            $('#editDate').val(fee.date);
            $('#editLastPaid').val(fee.last_paid);
            $('#editDueDate').val(fee.due_date);
            $('#editAmount').val(fee.amount);
            $('#editTotalAmount').val(fee.total_amount);
            $('#editStatus').val(fee.status);
            $('#editTransactionType').val(fee.transaction_type);
            $('#editModal').show();
            updateAmountBasedOnPackage(); // Update amount based on selected package
        } else {
            alert(response.error || 'No fee data found');
            $('#editFeeId').val(''); // treat as new
        }
    });
}

// Save Customer (for updates and general creates)
function saveCustomer() {
    const packageName = $('#editPackage').val();
    if (!packageName) {
        alert('Please select a package.');
        return;
    }

    const feeId = $('#editFeeId').val();
    const isNewFee = !feeId || feeId === '' || feeId === '0';
    const parsedFeeId = isNewFee ? null : parseInt(feeId);

    // Validate feeId for updates
    if (!isNewFee && (!parsedFeeId || isNaN(parsedFeeId))) {
        alert('Invalid fee ID. Please try again.');
        console.error('Invalid feeId:', feeId);
        return;
    }

    const lastPaidDate = new Date($('#editLastPaid').val() || new Date());
    const duration = dynamicPackageDurations[packageName] || PACKAGE_DURATIONS[packageName] || 1;
    const dueDate = new Date(lastPaidDate);
    dueDate.setMonth(dueDate.getMonth() + duration);
    if (dueDate.getDate() < lastPaidDate.getDate()) dueDate.setDate(0);

    const data = {
        id: parsedFeeId,
        customer_id: $('#editCustomerId').val() || '',
        name: $('#editName').val() || '',
        month: $('#editMonth').val() || ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][dueDate.getMonth()],
        join_date: $('#editDate').val() || new Date().toISOString().split('T')[0],
        last_paid: $('#editLastPaid').val() || new Date().toISOString().split('T')[0],
        due_date: dueDate.toISOString().split('T')[0],
        package: packageName,
        amount: parseFloat($('#editAmount').val()) || 0,
        total_amount: parseFloat($('#editTotalAmount').val()) || 0,
        status: $('#editStatus').val() || '1',
        transaction_type: $('#editTransactionType').val() || 'Cash',
    };

    console.log('Saving fee with data:', JSON.stringify(data, null, 2));

    $.ajax({
        url: '/api/fees/update/',
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        data: JSON.stringify(data),
        success: function(response) {
            console.log('Save response:', response);
            if (response.success) {
                alert('Fee ' + (isNewFee ? 'created' : 'updated') + ' successfully.');
                fetchFeeData().then(() => {
                    $('#editModal').hide();
                    populateFilters();
                }).catch(error => {
                    console.error('Error reloading fee data:', error);
                    alert('Error reloading fee data: ' + error.message);
                });
            } else {
                console.error('Update failed:', response.error);
                alert('Update failed: ' + (response.error || 'Unknown error'));
            }
        },
        error: function(xhr) {
            console.error('AJAX error:', xhr.responseText);
            alert('Error saving fee: ' + (xhr.responseJSON?.error || xhr.statusText || 'Server error'));
        }
    });
}

// Add Next Month Fee
async function addNextMonthFee(id) {
    const fee = feeData.find(f => f.id === id);
    if (!fee) {
        alert('Fee record not found for ID: ' + id);
        console.error('Fee not found for addNextMonthFee, ID:', id);
        return;
    }
    if (confirm(`Add fee for the next month for ${fee.name}?`)) {
        console.log('Adding next month fee for customer_id:', fee.customer_id);
        $('#editFeeId').val(fee.id);
        document.getElementById('editName').value = fee.name;
        document.getElementById('editCustomerId').value = fee.customer_id;
        document.getElementById('editPackage').value = '';
        document.getElementById('editAmount').value = '';
        document.getElementById('editAdvance').value = '';
        document.getElementById('editTotalAmount').value = '';
        document.getElementById('editDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('editLastPaid').value = '';
        document.getElementById('editDueDate').value = '';
        document.getElementById('editMonth').value = '';
        document.getElementById('editStatus').value = '1';
        document.getElementById('editTransactionType').value = fee.transaction_type || 'Cash';
        document.getElementById('editPhone').value = fee.phone || '';
        document.getElementById('editEmail').value = fee.email || '';
        document.getElementById('editModal').style.display = 'block';
        document.getElementById('editModal').dataset.action = 'addNextMonth';

        $('#editPackage').off('change').on('change', async function() {
            updateAmountBasedOnPackage();
            updateDueDate();
        });

        // Override Save button to call add_next_month_fee endpoint
        $('#saveCustomerButton').off('click').on('click', async function() {
            const packageName = $('#editPackage').val();
            if (!packageName) {
                alert('Please select a package.');
                return;
            }

            const lastPaidDate = new Date($('#editLastPaid').val() || new Date());
            const duration = dynamicPackageDurations[packageName] || PACKAGE_DURATIONS[packageName] || 1;
            const dueDate = new Date(lastPaidDate);
            dueDate.setMonth(dueDate.getMonth() + duration);
            if (dueDate.getDate() < lastPaidDate.getDate()) dueDate.setDate(0);

            const data = {
                customer_id: $('#editCustomerId').val() || '',
                name: $('#editName').val() || '',
                month: $('#editMonth').val() || ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][dueDate.getMonth()],
                last_paid: $('#editLastPaid').val() || new Date().toISOString().split('T')[0],
                package: packageName,
                amount: parseFloat($('#editAmount').val()) || 0,
                advance: parseFloat($('#editAdvance').val()) || 0,
                transaction_type: $('#editTransactionType').val() || 'Cash'
            };

            console.log('Adding next month fee with data:', JSON.stringify(data, null, 2));

            try {
                const response = await fetch(`{% url 'add_next_month_fee' customer_id=0 %}`.replace('0', fee.customer_id), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                console.log('Add next month fee response:', result);
                if (result.success) {
                    alert('Next month fee added successfully.');
                    fetchFeeData().then(() => {
                        $('#editModal').hide();
                        populateFilters();
                    }).catch(error => {
                        console.error('Error reloading fee data:', error);
                        alert('Error reloading fee data: ' + error.message);
                    });
                } else {
                    console.error('Add next month fee failed:', result.message);
                    alert('Failed to add next month fee: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('AJAX error:', error);
                alert('Error adding next month fee: ' + error.message);
            }
        });
    }
}

// Edit Fee
function editFee(feeId) {
    const fee = feeData.find(f => f.id === feeId);
    if (!fee) {
        alert('Fee record not found for ID: ' + feeId);
        console.error('Fee not found in feeData for ID:', feeId);
        return;
    }
    console.log('Editing fee with ID:', feeId, 'Data:', fee);
    $('#editFeeId').val(fee.id);
    $('#editName').val(fee.name);
    $('#editCustomerId').val(fee.customer_id);
    $('#editPackage').val(fee.package);
    $('#editAmount').val(fee.total_amount);
    $('#editAdvance').val(fee.advance || '');
    $('#editTotalAmount').val(fee.total_amount);
    $('#editDate').val(fee.date || '');
    $('#editLastPaid').val(fee.last_paid || '');
    $('#editDueDate').val(fee.due_date || '');
    $('#editMonth').val(fee.month || '');
    $('#editStatus').val(fee.status);
    $('#editTransactionType').val(fee.transaction_type || 'Cash');
    $('#editPhone').val(fee.phone || '');
    $('#editEmail').val(fee.email || '');
    $('#editModal').show();
    updateAmountBasedOnPackage(); // Update amount based on selected package
    // Restore default save behavior
    $('#saveCustomerButton').off('click').on('click', saveCustomer);
}

// Break Member
async function breakMember(id) {
    const fee = feeData.find(f => f.id === id);
    if (!fee) {
        alert('Fee record not found for ID: ' + id);
        return;
    }
    if (confirm(`Are you sure you want to put ${fee.name} on break?`)) {
        try {
            const response = await fetch(`{% url 'break_member' 0 %}`.replace('0', id), {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            console.log('Break Member Response:', result);
            if (result.success) {
                const feeIndex = feeData.findIndex(f => f.id === id);
                if (feeIndex !== -1) {
                    feeData[feeIndex].status = 3;
                    feeData[feeIndex].break_status = true;
                    feeData[feeIndex].is_overdue = false;
                }
                initializeDataTable();
                alert(result.message);
            } else {
                alert('Error putting member on break: ' + result.message);
            }
        } catch (error) {
            alert('Error putting member on break: ' + error.message);
        }
    }
}

async function unbreakMember(id) {
    const fee = feeData.find(f => f.id === id);
    if (!fee) {
        alert('Fee record not found for ID: ' + id);
        return;
    }

    if (confirm(`Are you sure you want to reactivate ${fee.name}?`)) {
        try {
            const response = await fetch(`{% url 'unbreak_member' 0 %}`.replace('0', id), {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            console.log('Unbreak Member Response:', result);

            if (result.success) {
                const feeIndex = feeData.findIndex(f => f.id === id);
                if (feeIndex !== -1 && result.updated_data) {
                    // Merge updated fields without losing existing ones
                    Object.assign(feeData[feeIndex], result.updated_data);
                }
                initializeDataTable();
                alert(result.message);
            } else {
                alert('Error reactivating member: ' + result.message);
            }

        } catch (error) {
            alert('Error reactivating member: ' + error.message);
            console.error('Error reactivating member:', error);
        }
    }
}

// WhatsApp Message Functions
function openWhatsAppModal(id) {
    const fee = feeData.find(f => f.id === id);
    if (!fee) {
        alert('Fee record not found for ID: ' + id);
        return;
    }
    document.getElementById('whatsappCustomerName').value = fee.name;
    document.getElementById('whatsappPhone').value = fee.phone || '';
    document.getElementById('whatsappMessage').value = `Hi ${fee.name},\n\nThis is a reminder regarding your gym membership.\n\nPackage: ${fee.package}\nDue Date: ${formatDate(fee.due_date)}\nAmount: ${formatCurrency(fee.total_amount)}\n\nPlease contact us for any queries.\n\nThank you!`;
    document.getElementById('whatsappModal').style.display = 'block';
    document.getElementById('whatsappModal').dataset.customerId = id;
}

async function sendWhatsAppMessage() {
    const customerId = document.getElementById('whatsappModal').dataset.customerId;
    const phone = document.getElementById('whatsappPhone').value;
    const message = document.getElementById('whatsappMessage').value;

    if (!phone || !message) {
        alert('Please fill in phone number and message');
        return;
    }

    try {
        const response = await fetch('{% url "send_whatsapp" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ customer_id: customerId, phone: phone, message: message })
        });
        const result = await response.json();
        console.log('Send WhatsApp Response:', result);
        if (result.success) {
            window.open(result.whatsapp_url, '_blank');
            closeModal('whatsappModal');
            alert('WhatsApp message opened successfully!');
        } else {
            alert('Error sending WhatsApp message: ' + result.message);
        }
    } catch (error) {
        alert('Error sending WhatsApp message: ' + error.message);
    }
}

// Send Overdue Notice
async function sendOverdueNotice(id) {
    const fee = feeData.find(f => f.id === id);
    if (!fee) {
        alert('Fee record not found for ID: ' + id);
        return;
    }
    if (confirm(`Send overdue notice to ${fee.name}?`)) {
        try {
            const response = await fetch(`{% url 'send_overdue_notice' 0 %}`.replace('0', id), {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            console.log('Send Overdue Notice Response:', result);
            if (result.success) {
                window.open(result.whatsapp_url, '_blank');
                alert('Overdue notice opened successfully!');
            } else {
                alert('Error sending overdue notice: ' + result.message);
            }
        } catch (error) {
            alert('Error sending overdue notice: ' + error.message);
        }
    }
}

// Print Receipt
async function printReceipt(id) {
    try {
        const response = await fetch(`{% url 'generate_receipt' customer_id=0 %}`.replace('0', id), {
            credentials: 'include'
        });
        const result = await response.json();
        console.log('Print Receipt Response:', result);
        if (result.success) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(result.receipt_html);
            printWindow.document.close();
            printWindow.print();
        } else {
            alert('Error fetching receipt: ' + result.message);
        }
    } catch (error) {
        alert('Error generating receipt: ' + error.message);
    }
}

// Init once globally
const paymentHistoryDT = $('#paymentHistoryTable').DataTable({
    responsive: true,
    dom: 'Bfrtip',
    buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
    pageLength: 10,
    ordering: true,
    searching: true
});

function showPaymentHistory(feeId, customerName) {
    $('#historyModalLabel').text(`Payment History for ${customerName || 'Customer'}`);

    $.ajax({
        url: `/payment_history/${feeId}/`,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(response) {
            console.log('Payment History Response:', response);

            paymentHistoryDT.clear(); // Clear old data

            if (response.success && response.history.length) {
                const rows = response.history.map(entry => [
                    formatDate(entry.date),
                    formatCurrency(entry.amount),
                    entry.method || '-',
                    getStatusText(entry.status),
                    formatDate(entry.created_at)
                ]);
                paymentHistoryDT.rows.add(rows).draw();
            } else {
                paymentHistoryDT.row.add([
                    'No payment history available.',
                    '', '', '', ''
                ]).draw();
            }

            $('#historyModal').modal('show');
        }
    });
}

// Utility function to format date
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Utility function to format currency
function formatCurrency(amount) {
    if (!amount) return '0.00';
    return parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
}

// Utility function to get status text
function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'completed': 'Completed',
        'failed': 'Failed'
    };
    return statusMap[status.toLowerCase()] || status || '-';
}

// Event Listeners
$(document).ready(function() {
    fetchFeeData();
    fetchPackages();

    $('#monthFilter, #statusFilter, #packageFilter').on('change', function() {
        applyFilters();
    });

    $('#editPackage').on('change', function() {
        updateAmountBasedOnPackage();
        updateDueDate();
    });

    $('#editAdvance').on('input', updateTotalAmount);

    $(window).on('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            });
        }
    });
});

// Close Modal
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}
</script>
</body>
</html>